---
heroImage: /src/assets/images/cover_Raindrops.png
category: å®è·µè®°å½•
description: Unityä¸‹URPé«˜æ–¯æ¨¡ç³Šä¸é›¨æ»´å±å¹•åå¤„ç†æ•ˆæœ
pubDate: 2025-01-25T16:00:00.000Z
tags:
  - æ¸²æŸ“æ•ˆæœ
  - åå¤„ç†
title: ã€åå¤„ç†ã€‘é›¨æ»´å±å¹•æ•ˆæœ
---

import LocalVideo from '../../components/LocalVideo.astro'

<LocalVideo src='/assets/Effects/Raindrops/video1.mp4' alt='video1' />

### å…·ä½“å®ç°

#### Grid ç½‘æ ¼

å°†uvåˆ‡åˆ†æˆå°çš„ç½‘æ ¼ï¼Œæ¯ä¸€æ»´é›¨æ»´åœ¨å„è‡ªçš„ç½‘æ ¼ä¸­ä»ä¸Šå¾€ä¸‹æ»‘è½

```c
fixed4 frag (v2f i) : SV_Target
{
    float4 col = 0;
    float2 uv = i.uv * _Size;
    float2 gv = frac(uv);
    col.rg = gv;
    return col;
}

```

<img
	src='/assets/Effects/Raindrops/img1.png'
	alt='img1'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<br></br>

#### Boxes

å°†æ¯ä¸€ä¸ªå°æ–¹æ ¼å˜æˆçºµå‘æ’å¸ƒçš„é•¿æ–¹å½¢ï¼Œä¹‹åé›¨æ»´å¯ä»¥ä»ä¸Šå¾€ä¸‹çºµå‘æ»‘è½è¾ƒé•¿çš„è·ç¦»

```c
float2 aspect = float2(4,1); // å°†uå‹ç¼©æˆ1/4ï¼Œ vä¸å˜
float2 uv = i.uv * _Size * aspect;
float2 gv = frac(uv) - 0.5; // å–å°æ•°å¹¶å°†ä¸­å¿ƒç‚¹ä»å·¦ä¸‹è§’ç§»åŠ¨åˆ°ä¸­å¿ƒ

```

```c
if (gv.x > 0.48 || gv.y > 0.48)
{
    // å°†æ¯ä¸€ä¸ªæ–¹æ¡†çš„è¾¹ç¼˜æ˜¾ç¤ºä¸ºçº¢çº¿
    col = float4(1,0,0,1);
}

```

<img
	src='/assets/Effects/Raindrops/img2.png'
	alt='img2'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<br></br>

#### Drop é›¨æ»´

æ¨¡æ‹Ÿé›¨ç‚¹, é€šè¿‡smoothstepç”Ÿæˆå°ç™½ç‚¹

```c
float drop = smoothstep(0.05, 0.03, length(gv));
col += drop;

```

> ğŸ“£ **smoothstep(a, b, x)**
>
> - smoothstepå¯ä»¥ç”¨æ¥ç”Ÿæˆ0åˆ°1çš„å¹³æ»‘è¿‡æ¸¡å€¼ï¼Œå®ƒä¹Ÿå«å¹³æ»‘é˜¶æ¢¯å‡½æ•°
> - å½“ x < a æ—¶ï¼Œè¿”å› 0ï¼Œå½“ x > b æ—¶ï¼Œè¿”å› 1ï¼Œå¦åˆ™åœ¨ 0å’Œ 1ä¹‹é—´å¹³æ»‘è¿‡æ¸¡

<img
	src='/assets/Effects/Raindrops/img3.png'
	alt='img3'
	style='width: 10%; height: auto; display:block; margin: 0 auto;'
/>
<br></br>

<img
	src='/assets/Effects/Raindrops/img4.png'
	alt='img4'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

æ ¹æ®aspectè°ƒæ•´è¢«æ‹‰ä¼¸çš„å°ç™½ç‚¹

```c
float2 dropPos = gv / aspect;
float drop = smoothstep(0.05, 0.03, length(dropPos));
col += drop;

```

<img
	src='/assets/Effects/Raindrops/img5.png'
	alt='img5'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<br></br>

#### Move æ»‘åŠ¨

é›¨ç‚¹ä»ä¸Šåˆ°ä¸‹æ»‘åŠ¨ï¼Œ é€šè¿‡å˜é‡xå’Œyæ¥æ§åˆ¶é›¨ç‚¹çš„ä½ç½®

```c
// é€šè¿‡xyæ¥æ§åˆ¶é›¨ç‚¹çš„ä½ç½®
float x = 0;
float y = 0;

float2 dropPos = gv - float2(x,y) / aspect;
float drop = smoothstep(0.05, 0.03, length(dropPos));
col += drop;

```

<img
	src='/assets/Effects/Raindrops/img6.png'
	alt='img6'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

é€šè¿‡\_Time.yä¸sin()æ¥æ§åˆ¶é›¨æ»´æ»‘è½åŠ¨ç”»

- sin(y)å¾—åˆ°çš„ç»“æœæ˜¯[-1, 1], éœ€è¦é’³åˆ¶åœ¨[-0.5, 0.5]ä¹‹é—´ï¼Œè€Œä¸ºäº†è®©é›¨ç‚¹å®Œæ•´çš„å‡ºç°åœ¨æ–¹æ¡†å†…ï¼Œæ˜ å°„åˆ°[-0.43, 0.43]æ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©

```c
float t = _Time.y;

...

// é€šè¿‡xyæ¥æ§åˆ¶é›¨ç‚¹çš„ä½ç½®
float x = 0;
float y = sin(t) * 0.43;

float2 dropPos = (gv - float2(x,y)) / aspect;
float drop = smoothstep(0.05, 0.03, length(dropPos));
col += drop;

```

<LocalVideo src='/assets/Effects/Raindrops/video2.mp4' alt='video2' />

---

è°ƒæ•´æ»‘è½æ•ˆæœ

- ç°åœ¨é›¨æ»´çš„ä¸‹é™ä¸ä¸Šå‡æ˜¯åŒ€é€Ÿçš„ï¼Œç›®æ ‡æ•ˆæœæ˜¯é›¨æ»´å¿«é€Ÿä¸‹é™ï¼Œç¼“æ…¢ä¸Šå‡
- é›¨æ»´ç¼“æ…¢ä¸Šå‡çš„æ•ˆæœå°†åœ¨ä¹‹åè¢«ç½‘æ ¼æ•´ä½“ä¸‹ç§»çš„æ•ˆæœæŠµæ¶ˆ
- ä¿®æ”¹sin(t)ä½¿è·å¾—ä¸€ç§ç¬¦åˆé¢„æœŸæ•ˆæœçš„å›¾åƒ
- $$-sin(x + sin(x + sin(x) * 0.5))$$

<img
	src='/assets/Effects/Raindrops/img7.png'
	alt='img7'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

```c
float y = -sin(t + sin(t + sin(t) * 0.5)) * 0.43;

```

<LocalVideo src='/assets/Effects/Raindrops/video3.mp4' alt='video3' />

<br></br>

#### Grid Movement

é€šè¿‡å‘ä¸‹ç§»åŠ¨æ–¹æ ¼æ¥æŠµæ¶ˆé›¨æ»´ä¸Šç§»çš„æ•ˆæœ

```c
uv.y += t * 0.25; // - é€šè¿‡å‘ä¸‹ç§»åŠ¨æ–¹æ ¼æ¥æŠµæ¶ˆé›¨æ»´ä¸Šç§»çš„æ•ˆæœ
```

<LocalVideo src='/assets/Effects/Raindrops/video4.mp4' alt='video4' />

<br></br>

#### é›¨æ»´æ‹–å°¾

åˆ›å»ºæ‹–å°¾é›¨æ»´

- æ‹–å°¾é›¨æ»´çš„åˆ›å»ºæ–¹æ³•ä¸ä¹‹å‰ä¸€æ ·ï¼Œé€šè¿‡smoothstepåˆ›å»ºé›¨æ»´å½¢çŠ¶
- å½“å‰é›¨æ»´ä½ç½®åœ¨æ–¹æ¡†ä¸­å¿ƒï¼Œä¸”ä¼šéšç€æ–¹æ¡†ç§»åŠ¨

```c
float2 trailPos = (gv - float2(x,0)) / aspect;
float trail = smoothstep(0.03, 0.01, length(trailPos));
```

<img
	src='/assets/Effects/Raindrops/img8.png'
	alt='img8'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

å°†æ¯ä¸ªæ–¹æ¡†åˆ‡åˆ†æˆæ›´å°çš„æ–¹æ¡†

- åˆ‡åˆ†çš„é€»è¾‘ä¸æœ€å¼€å§‹åˆ›å»ºgridæ—¶ä¸€æ ·
- æ¯ä¸ªå°å°æ–¹æ¡†å†…ä¼šæœ‰ä¸€æ»´æ‹–å°¾é›¨ç‚¹

```c
    trailPos.y = frac(trailPos.y * 8);
```

<img
	src='/assets/Effects/Raindrops/img9.png'
	alt='img9'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

è¿˜åŸå‹ç¼©ä¸åç§»

- åœ¨åˆ‡åˆ†æ—¶çºµå‘å‹ç¼©äº†å°é›¨æ»´ï¼Œæ‰€ä»¥è¦ä¹˜ä»¥å‹ç¼©çš„é‡ /8
- åŒæ—¶è¦å°†å°å°æ–¹æ¡†çš„ä¸­å¿ƒç‚¹ç§»åŠ¨åˆ°æ–¹æ¡†ä¸­å¿ƒ -0.5

```c
    trailPos.y = (frac(trailPos.y * 8) - 0.5) / 8;
```

<img
	src='/assets/Effects/Raindrops/img10.png'
	alt='img10'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

é›¨æ»´æ‹–å°¾åº”è¯¥å›ºå®šåœ¨é¢ç‰‡ä¸Š

- å½“å‰æ•ˆæœï¼Œé›¨æ»´ä¼šéšç€æ–¹æ¡†ä¸€èµ·å‘ä¸‹ç§»åŠ¨ï¼Œè€ŒçœŸå®çš„é›¨æ»´æ‹–å°¾ä¼šå›ºå®šåœ¨çª—æˆ·çš„ä¾¿é¢
- é€šè¿‡æ–¹æ¡†çš„ç§»åŠ¨é‡æ¥æŠµæ¶ˆæ‹–å°¾çš„ç§»åŠ¨ (å³è®©æ‹–å°¾å‘ä¸Šç§»åŠ¨)

```c
uv.y += t * 0.25; // - é€šè¿‡å‘ä¸‹ç§»åŠ¨æ–¹æ ¼æ¥æŠµæ¶ˆé›¨æ»´ä¸Šç§»çš„æ•ˆæœ

...

float2 trailPos = (gv - float2(x, t * 0.25)) / aspect;
```

---

æ‹–å°¾é®ç½©

- åœ¨main dropä¸‹é¢çš„æ‹–å°¾ä¸åº”è¯¥æ˜¾ç¤º
- é€šè¿‡smoothstepæ¥åˆ¤æ–­åœ¨maindropä¸‹çš„æ‹–å°¾

<img
	src='/assets/Effects/Raindrops/img11.png'
	alt='img11'
	style='width: 15%; height: auto; display:block; margin: 0 auto;'
/>

- åœ¨maindropä»¥ä¸‹åƒç´ çš„dropPosæ˜¯è´Ÿæ•°ï¼Œåœ¨maindropä»¥ä¸Šåƒç´ çš„dropPosæ˜¯æ­£æ•°ã€‚å¯ä»¥ä½¿ç”¨dropPosæ¥å……å½“maskåˆ¤æ–­æ¡ä»¶ä»¥å»ºç«‹æ‹–å°¾çš„æ¨¡æ¿

```c
trail *= dropPos.y; //æ‹–å°¾mask
```

<img
	src='/assets/Effects/Raindrops/img12.png'
	alt='img12'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<br></br>

- é€šè¿‡smoothstepæ¥è¿›ä¸€æ­¥ä¼˜åŒ–maskè¾¹ç¼˜ï¼ˆé’³åˆ¶maskå¯¹æ¯”åº¦ï¼‰

<img
	src='/assets/Effects/Raindrops/img13.png'
	alt='img13'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

æ‹–å°¾çš„æ¸éšæ•ˆæœ

- æ ¹æ®maindropçš„ä½ç½®ï¼Œå¯¹maindropä»¥ä¸Šçš„åŒºåŸŸå»ºç«‹ä¸€ä¸ªæ¸å˜é®ç½©(0~1)

<img
	src='/assets/Effects/Raindrops/img14.png'
	alt='img14'
	style='width: 40%; height: auto; display:block; margin: 0 auto;'
/>

- çº¢è‰²æ–¹æ¡†æœ€é¡¶éƒ¨y = 0.5, æœ€åº•éƒ¨ y = -0.5
- maindropçš„ä½ç½®é€šè¿‡ float y = -sin(t + sin(t + sin(t) _ 0.5)) _ 0.43;æ¥æ§åˆ¶
- gv.yè¡¨ç¤ºæ–¹æ¡†å†…å½“å‰åƒç´ ä½ç½®

```c
// æ¸éšæ•ˆæœ
// smoothstep(æ–¹æ¡†é¡¶éƒ¨yï¼Œ maindropä½ç½®yï¼Œ å½“å‰ä½ç½®y);
trail *= smoothstep(0.5, y, gv.y);
```

<img
	src='/assets/Effects/Raindrops/img15.png'
	alt='img15'
	style='width: 40%; height: auto; display:block; margin: 0 auto;'
/>

<br></br>

#### è°ƒæ•´ MainDrop å½¢çŠ¶

ç°åœ¨maindropæ˜¯æ­£åœ†å½¢ï¼Œéœ€è¦è°ƒæ•´æˆä¸Šçª„ä¸‹å®½çš„é›¨æ»´å½¢çŠ¶

```c
y -= gv.x * gv.x; //è°ƒæ•´é›¨æ»´å½¢çŠ¶
```

<img
	src='/assets/Effects/Raindrops/img16.png'
	alt='img16'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

æ·»åŠ wiggleæ•ˆæœ

- é€šè¿‡è°ƒæ•´maindropçš„xæ¥æ§åˆ¶é›¨æ»´æ‰­æ›²çš„æ•ˆæœ
- é€šè¿‡å¯¹sin(x)è¿›è¡Œè¿›ä¸€æ­¥çš„è°ƒæ•´å¾—åˆ°è¿™æ ·çš„å›¾åƒï¼š
- $$ sin(3x)sin(x)^6 $$

<img
	src='/assets/Effects/Raindrops/img17.png'
	alt='img17'
	style='width: 100%; height: auto; display:block; margin: 0 auto;'
/>

```c
    // é€šè¿‡xyæ¥æ§åˆ¶é›¨ç‚¹çš„ä½ç½®
    float w = i.uv.y * 10; // wiggles
    float x = sin(3 * w) * pow(sin(w), 6) * 0.43;
    float y = -sin(t + sin(t + sin(t) * 0.5)) * 0.43;

    // -x æ˜¯ä¸ºäº†å¹³è¡¡wiggleså¸¦æ¥çš„åå·®
    y -= (gv.x-x) * (gv.x-x); //è°ƒæ•´é›¨æ»´å½¢çŠ¶
```

<LocalVideo src='/assets/Effects/Raindrops/video5.mp4' alt='video5' />

<br></br>

#### æ‰“ä¹±æ¯ä¸ªboxä¸­maindropçš„æµåŠ¨

ç»™æ¯ä¸€ä¸ªboxåˆ†é…ä¸€ä¸ªidï¼Œå†é€šè¿‡è¿™ä¸ªidç”Ÿæˆéšæœºæ•°æ¥æ‰“ä¹±æ¯ä¸€ä¸ªmaindropçš„è¿åŠ¨
ç»™æ¯ä¸€ä¸ªboxç”ŸæˆID

```c
float2 id = floor(uv);
col.rg = id * 0.1;

```

<img
	src='/assets/Effects/Raindrops/img18.png'
	alt='img18'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

é€šè¿‡idç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼ˆ0~1ï¼‰

- é€šè¿‡å°†idè¿›è¡Œä¸€äº›æ•°å­¦è¿ç®—å¾—å‡ºä¸€ä¸ªéš¾ä»¥è§‚æµ‹åˆ°è§„å¾‹çš„æ•°ä½œä¸ºéšæœºæ•°

```c
    // é€šè¿‡idç”Ÿæˆä¸€ä¸ªéšæœºæ•°
    float genRandomNum(float2 p)
    {
        p = frac(p * float2(123.34, 345.45));
        p += dot(p, p + 34.345);
        return frac(p.x * p.y);
    }
```

```c
    fixed4 frag (v2f i) : SV_Target
    {
        ...
        col += genRandomNum(id);
        return col;
    }
```

<img
	src='/assets/Effects/Raindrops/img19.png'
	alt='img19'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

é€šè¿‡éšæœºæ•°æ¥ç»™æ¯ä¸€ä¸ªboxæ·»åŠ yè½´åç§»å€¼

```c
    // é€šè¿‡éšæœºæ•°ç»™æ¯ä¸€ä¸ªboxå¢åŠ æ—¶é—´åç§»å€¼
    float random = genRandomNum(id); // [0,1]
    t += random * 2 * PI; // sin wave phase

```

<LocalVideo src='/assets/Effects/Raindrops/video6.mp4' alt='video6' />

---

é€šè¿‡éšæœºæ•°æ¥ç»™æ¯ä¸€ä¸ªboxæ·»åŠ xè½´åç§»å€¼

```c
    float x = (random - 0.5) * 0.8; // [-0.4, 0.4]
    x += (0.4 - abs(x)) * sin(3 * w) * pow(sin(w), 6) * 0.43;// 0 - 0.4 - 0 è¾¹ç¼˜ä¸º0ï¼Œä¸­é—´æœ€å¤§
```

<br></br>

#### FogTrail é›¾æ°”æ‹–å°¾

æ¨¡æ‹Ÿçª—æˆ·ä¸Šçš„é›¾æ°”æ•ˆæœï¼Œé›¨æ»´æ‹–å°¾åˆ’è¿‡fogå˜æ¸…æ™°
å°†åŸæœ¬é›¨æ»´æ‹–å°¾çš„maskä½œä¸ºfog

```c
    float2 trailPos = (gv - float2(x, t * 0.25)) / aspect;
    trailPos.y = (frac(trailPos.y * 8) - 0.5) / 8;
    float trail = smoothstep(0.03, 0.01, length(trailPos));

    float fogTrail = smoothstep(-0.05, 0.05, dropPos.y); //fog
    fogTrail *= smoothstep(0.5, y, gv.y); //æ¸éšæ•ˆæœ

    return fogTrail * 0.5;
```

- fog

<img
	src='/assets/Effects/Raindrops/img20.png'
	alt='img20'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

- fog + drops

<img
	src='/assets/Effects/Raindrops/img21.png'
	alt='img21'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

è£å‰ªæ‰å·¦å³ä¸¤ä¾§çš„é›¾æ°”ï¼Œåªç•™ä¸‹trailsåŒºåŸŸå†…çš„fog

- ä»¥dropPosçš„xè½´ä¸ºåˆ¤æ–­æ¡ä»¶

```c
fogTrail *= smoothstep(0.05, 0.04, abs(dropPos.x)); //è£å‰ªå·¦å³ä¸¤ä¾§fog
```

<img
	src='/assets/Effects/Raindrops/img21.png'
	alt='img22'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<br></br>

#### é›¨æ»´ä¸­çš„æ‰­æ›²

é›¨æ»´ä¼šå½¢æˆä¸€ç§å‡¸é€é•œçš„æ•ˆæœï¼Œæ‰­æ›²é‡‡æ ·åˆ°çš„å±å¹•å›¾åƒ
ä»…åœ¨é›¨æ»´åŒºåŸŸå¯¹uvæ·»åŠ offsetï¼Œä»¥è¾¾åˆ°é›¨æ»´åŒºåŸŸå†…çš„æ‰­æ›²æ•ˆæœ

---

ç¡®å®šé›¨æ»´åŒºåŸŸ

- dropç›¸å½“äºmaskï¼Œç¡®å®šå‡ºé›¨æ»´çš„åŒºåŸŸ
- dropPos å·²ç»æ˜¯ç»è¿‡é›¨æ»´å½¢çŠ¶ä¸æ—¶é—´æ‰­æ›²çš„
- é›¨æ»´ä»¥å¤–çš„å…¶ä»–åŒºåŸŸæ˜¯0ï¼Œä¸å½±å“åŸæ¥uv

<img
	src='/assets/Effects/Raindrops/img23.png'
	alt='img23'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

---

æ‰­æ›²uv

- é€šè¿‡\_Distortionæ¥æ§åˆ¶æ‰­æ›²æ•ˆæœ
- é›¨æ»´ä¸­çš„æˆåƒæ˜¯å€’è¿‡æ¥çš„ï¼Œæ‰€ä»¥é€‰ç”¨è´Ÿæ•°çš„\_Distortion

```c
float2 offset = drop * dropPos + trail * trailPos;
col = tex2D(_MainTex, i.uv + offset * _Distortion);
```

- å®Œæ•´é¢ç‰‡

<img
	src='/assets/Effects/Raindrops/img24.png'
	alt='img24'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

- é›¨æ»´ç»†èŠ‚

<img
	src='/assets/Effects/Raindrops/img25.png'
	alt='img25'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<LocalVideo src='/assets/Effects/Raindrops/video7.mp4' alt='video7' />

<br></br>

#### Fog é›¾æ°”

é…åˆé«˜æ–¯æ¨¡ç³Šåå¤„ç†æ¨¡æ‹Ÿé›¾æ°”

- å°†color bufferä¸­çš„å›¾åƒç»è¿‡é«˜æ–¯æ¨¡ç³Šåå¤„ç†åä¸åŸå›¾åƒä¸€èµ·ä¼ å…¥RainDrop shader
- å°†fogTrailä½œä¸ºé®ç½©ï¼Œfogtrailæ»‘è¿‡çš„åœ°æ–¹é‡‡æ ·æ¸…æ™°çš„\_clearTexå›¾åƒï¼Œå…¶ä»–åœ°æ–¹é‡‡æ ·é«˜æ–¯æ¨¡ç³Šè¿‡çš„\_BlurredTex

---

- é«˜æ–¯æ¨¡ç³Š + é›¨æ»´åå¤„ç†è„šæœ¬

```c
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[ExecuteInEditMode]
public class Post : MonoBehaviour
{
    [Header("Shader Assignment")]
    public Shader BlurShader;
    public Shader RainShader;

    [Space]
    [Header("Blur Settings")]
    [Range(1.0f, 10.0f)]
    public float BlurRadius = 1.0f;      //æ¨¡ç³ŠåŠå¾„
    [Range(0.0f, 5.0f)]
    public int downSample = 2;      //é™åˆ†è¾¨ç‡
    [Range(1.0f, 5.0f)]
    public int iteration = 1;      //è¿­ä»£æ¬¡æ•°

    [Space]
    [Header("Raindrop Settings")]
    [Range(0.5f, 2.0f)]
    public float RainDropSize = 0.7f;       // å¯¹åº” _Size
    [Range(-5.0f, 5.0f)]
    public float distortion = 1f;   // å¯¹åº” _Distortion
    [Range(0.0f, 1.0f)]
    public float darkness = 0.5f;

    private void OnRenderImage(RenderTexture src, RenderTexture dest)
    {
        // é«˜æ–¯æ¨¡ç³Š -----------------------------
        Material blurMaterial = new Material(BlurShader);
        RenderTexture buffer=RenderTexture.GetTemporary(src.width, src.height);
        Graphics.Blit(src, buffer);

        //ç”³è¯·RenderTextureï¼ŒRTçš„åˆ†è¾¨ç‡æŒ‰ç…§downSampleé™ä½
        RenderTexture rt1 = RenderTexture.GetTemporary(buffer.width >> downSample, buffer.height >> downSample, 0, buffer.format);
        RenderTexture rt2 = RenderTexture.GetTemporary(buffer.width >> downSample, buffer.height >> downSample, 0, buffer.format);

        //ç›´æ¥å°†åŸå›¾æ‹·è´åˆ°é™åˆ†è¾¨ç‡çš„RTä¸Š
        Graphics.Blit(buffer, rt1);

        //è¿­ä»£
        for (int i = 0; i < iteration; i++)
        {
            //ç¬¬ä¸€æ¬¡é«˜æ–¯æ¨¡ç³Šï¼Œè®¾ç½®offsetsï¼Œç«–å‘æ¨¡ç³Š
            blurMaterial.SetVector("_offsets", new Vector4(0, BlurRadius, 0, 0));
            Graphics.Blit(rt1, rt2, blurMaterial);
            //ç¬¬äºŒæ¬¡é«˜æ–¯æ¨¡ç³Šï¼Œè®¾ç½®offsetsï¼Œæ¨ªå‘æ¨¡ç³Š
            blurMaterial.SetVector("_offsets", new Vector4(BlurRadius, 0, 0, 0));
            Graphics.Blit(rt2, rt1, blurMaterial);
        }

        //å°†æœ€åç»“æœä¼ é€’åˆ°destination
        Graphics.Blit(rt1, buffer);

        //é‡Šæ”¾ç”³è¯·çš„ä¸¤å—RenderBufferå†…å®¹
        RenderTexture.ReleaseTemporary(rt1);
        RenderTexture.ReleaseTemporary(rt2);

        // é›¨æ»´ -----------------------------
        Material rainMaterial = new Material(RainShader);

        // Set the properties
        rainMaterial.SetFloat("_Size", RainDropSize);
        rainMaterial.SetFloat("_Distortion", distortion);
        rainMaterial.SetFloat("_Darkness", darkness);
        rainMaterial.SetTexture("_BlurredTex", buffer); // ä¼ å…¥æ¨¡ç³Šåçš„å›¾åƒ

        Graphics.Blit(src, dest, rainMaterial);
        RenderTexture.ReleaseTemporary(buffer);
    }
}

```

---

å°†FogTrailä½œä¸ºè’™ç‰ˆï¼Œé‡‡æ ·ä¸¤å¼ color bufferå›¾

- fogtrailæ»‘è¿‡çš„åœ°æ–¹é‡‡æ ·æ¸…æ™°çš„\_clearTexå›¾åƒ
- å…¶ä»–åœ°æ–¹é‡‡æ ·é«˜æ–¯æ¨¡ç³Šè¿‡çš„\_BlurredTex

```c
fixed4 clearTex = tex2D(_MainTex, i.uv + offset * _Distortion);
fixed4 blurredTex = tex2D(_BlurredTex,i.uv + offset * _Distortion) * _Darkness;
col = lerp(blurredTex, clearTex,fogTrail);
return col;

```

- fogTrail

<img
	src='/assets/Effects/Raindrops/img26.png'
	alt='img26'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

- raindrop + gaussian blur

<img
	src='/assets/Effects/Raindrops/img27.png'
	alt='img27'
	style='width: 70%; height: auto; display:block; margin: 0 auto;'
/>

<LocalVideo src='/assets/Effects/Raindrops/video8.mp4' alt='video8' />

<br></br>

#### å¢åŠ é›¨æ»´å±‚æ¬¡

å°†é›¨æ»´ç§»åŠ¨åˆ° _rainDropLayer()_ å‡½æ•°ä¸­

- è¿”å›offset
- è¿”å›fogTrail

```c
// é›¨æ»´å±‚æ¬¡
float3 rainDropLayer(float2 UV, float t)
{

    float2 resolution = float2(16,9) / 2; // æ ¹æ®å±å¹•åˆ†è¾¨ç‡è°ƒæ•´
    float2 aspect = float2(2,1); // å°†uå‹ç¼©æˆ1/4ï¼Œ vä¸å˜
    float2 uv = UV * _Size * aspect * resolution;
    uv.y += t * 0.25; // - é€šè¿‡å‘ä¸‹ç§»åŠ¨æ–¹æ ¼æ¥æŠµæ¶ˆé›¨æ»´ä¸Šç§»çš„æ•ˆæœ
    float2 gv = frac(uv) - 0.5; // å–å°æ•°å¹¶å°†ä¸­å¿ƒç‚¹ä»å·¦ä¸‹è§’ç§»åŠ¨åˆ°ä¸­å¿ƒ
    float2 id = floor(uv);

    // é€šè¿‡éšæœºæ•°ç»™æ¯ä¸€ä¸ªboxå¢åŠ æ—¶é—´åç§»å€¼
    float random = genRandomNum(id); // [0,1]
    t += random * 2 * PI; // sin wave phase

    // é€šè¿‡xyæ¥æ§åˆ¶é›¨ç‚¹çš„ä½ç½®
    float w = UV.y * 10; // wiggles
    float x = (random - 0.5) * 0.8; // [-0.4, 0.4]
    x += (0.4 - abs(x)) * sin(3 * w) * pow(sin(w), 6) * 0.43;// 0 - 0.4 - 0 è¾¹ç¼˜ä¸º0ï¼Œä¸­é—´æœ€å¤§
    float y = -sin(t + sin(t + sin(t) * 0.5)) * 0.43;
    y -= (gv.x-x) * (gv.x-x); //è°ƒæ•´é›¨æ»´å½¢çŠ¶

    float2 dropPos = (gv - float2(x,y)) / aspect;
    float drop = smoothstep(0.05, 0.03, length(dropPos));

    float2 trailPos = (gv - float2(x, t * 0.25)) / aspect;
    trailPos.y = (frac(trailPos.y * 8) - 0.5) / 8;
    float trail = smoothstep(0.03, 0.01, length(trailPos));
    float fogTrail = smoothstep(-0.05, 0.05, dropPos.y); //fog
    fogTrail *= smoothstep(0.5, y, gv.y); //æ¸éšæ•ˆæœ
    trail *= fogTrail; //fogä½œä¸ºé›¨æ»´æ‹–å°¾çš„mask
    fogTrail *= smoothstep(0.05, 0.04, abs(dropPos.x)); //è£å‰ªå·¦å³ä¸¤ä¾§fog

    // é›¨æ»´æ‰­æ›²
    float2 offset = drop * dropPos + trail * trailPos;

    return float3(offset, fogTrail);
}
```

```c
fixed4 frag (v2f i) : SV_Target
{
    float4 col = 0;
    float t = _Time.y;

    float3 drops = rainDropLayer(i.uv, t);
    float2 offset = drops.xy;
    float fogTrail = drops.z;

    fixed4 clearTex = tex2D(_MainTex, i.uv + offset * _Distortion);
    fixed4 blurredTex = tex2D(_BlurredTex,i.uv + offset * _Distortion) * _Darkness;
    col = lerp(blurredTex, clearTex,fogTrail);
    return col;
}
```

---

æ·»åŠ æ›´å¤šé›¨æ»´

```c
float3 drops = rainDropLayer(i.uv, t);
drops += rainDropLayer(i.uv * 1.66 + 1.54, t);
drops += rainDropLayer(i.uv * 0.88 - 7.26, t)
```

<LocalVideo src='/assets/Effects/Raindrops/video9.mp4' alt='video9' />

<br></br>

### ç›¸å…³èµ„æº

Making a rainy window in Unity

- https://www.youtube.com/watch?v=0flY11lVCwY&t=378s

é«˜å“è´¨åå¤„ç†ï¼šåç§å›¾åƒæ¨¡ç³Šç®—æ³•çš„æ€»ç»“ä¸å®ç°

- https://zhuanlan.zhihu.com/p/125744132
